---
params:
  project_name: NULL
  project_number: NULL
  qualified: NULL
  unqualified: NULL
  push_log: system.file("push_log.csv", package = "otndo")
  deployment: NULL
  since: NULL
format:
  html:
    self-contained: true
execute:
  echo: false
title: "`r paste('Receiver data push summary:', params$project_name)`"
author: "Created with the [`otndo` R package](https://otndo.obrien.page) (v. `r packageVersion('otndo')`)"
---
```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE
)
```


```{r}
#| label: packages
#| message: false

library(data.table)
library(sf)
library(mapview)
library(ggplot2)
library(reactable)
```

```{r}
#| label: extraction-files-read

qualified <- data.table::fread(params$qualified)
unqualified <- data.table::fread(params$unqualified)

push_log <- data.table::fread(params$push_log)
```

```{r}
#| label: n-pis
#| warning: false

pis <- project_contacts(qualified, type = "receiver")
```

```{r}
#| label: otn-query

projects <- unique(qualified$trackercode)

otn_tables <- otn_query(projects)
```


```{r}
#| label: proper-urls

# if(act_eval){
#   act <- paste0('https://matos.asascience.com/project/detail/',
#                 params$project_number)
#   otn <- paste0('https://members.oceantrack.org/OTN/project?ccode=ACT.PROJ',
#                 params$project_number)
# }else{
act <- "https://matos.asascience.com/project"
otn <- "https://members.oceantrack.org/OTN/projects"
# }
```

These are data related to receiver data from the `r format(push_log$date[nrow(push_log)], '%B %Y')` OTN data push. New matched detection files (["qualified" files](https://members.oceantrack.org/data/otn-detection-extract-documentation-matched-to-animals#autotoc-item-autotoc-2)) were uploaded on `r format(push_log$date[nrow(push_log)], '%B %d')`. The previous data push occurred on `r format(push_log$date[nrow(push_log) - 1], '%B %d, %Y')`.


## Overall

A total of `r format(nrow(qualified), big.mark = ',')` detections of `r uniqueN(qualified, by  = 'fieldnumber')` individuals have been matched via [ACT](`r act`), [FACT](https://secoora.org/fact/projects/), and/or [OTN](`r otn`). The detections span across `r uniqueN(qualified, by = 'trackercode')` different projects consisting of `r length(unique(unlist(strsplit(pis$PI, ',\\s?'))))` principal investigators.


```{r}
#| label: otn-match-table
#| column: page
#| fig-cap: Table 1. Total detections and number of individual fish heard from other OTN node projects.
#| fig-cap-location: top

mt <- prep_match_table(qualified, pis, type = "receiver")

reactable::reactable(mt,
  columns = list(
    PI = reactable::colDef(
      html = T,
      cell = function(value, index) {
        sprintf(
          '<a href=mailto:%s target="_blank">%s</a>',
          mt$PI_emails[index], value
        )
      },
      minWidth = 150
    ),
    POC = reactable::colDef(
      html = T,
      cell = function(value, index) {
        sprintf(
          '<a href=mailto:%s target="_blank">%s</a>',
          mt$POC_emails[index], value
        )
      },
      minWidth = 150
    ),
    PI_emails = reactable::colDef(show = F),
    POC_emails = reactable::colDef(show = F),
    `Project name` = reactable::colDef(minWidth = 200)
  )
)
```

```{r}
#| label: otn-match-map
#| fig-cap: Figure 1. Bounding box of detected external projects. This does not necessarily reflect the distribution of fish heard by this project's receivers.

match_map(otn_tables)
```


```{r}
#| label: temporal-distribution
#| fig-cap: Figure 2. Temporal distribution of detections by external project, i.e., the dates when this project heard other project's fish.

qualified_time <- prep_temporal_distribution(qualified, "receiver")

ggplot2::ggplot(qualified_time) +
  ggplot2::geom_tile(ggplot2::aes(x = day, y = gsub(".*\\.", "", trackercode))) +
  ggplot2::labs(
    x = "", y = "",
    subtitle = "Temporal distribution of detections by project"
  ) +
  ggplot2::theme_minimal()
```


```{r}
#| label: deployment-gantt
#| fig-cap: Figure 3. Deployment record of receivers across time. Black bars indicate periods of deployments, while red bars denote download dates.

if (!is.null(params$deployment)) {
  deployment <- data.table::fread(params$deployment)

  ggplot2::ggplot(data = deployment) +
    ggplot2::geom_linerange(
      ggplot2::aes(
        y = stationname,
        xmin = deploy_date_time,
        xmax = recover_date_time
      ),
      linewidth = 5
    ) +
    ggplot2::geom_linerange(
      ggplot2::aes(
        ymin = as.numeric(factor(stationname)) - 0.4,
        ymax = as.numeric(factor(stationname)) + 0.4,
        x = recover_date_time
      ),
      color = "red", linewidth = 2
    ) +
    ggplot2::scale_x_datetime(date_breaks = "month", date_labels = "%b %y") +
    ggplot2::labs(x = NULL, y = NULL, title = "Temporal receiver coverage") +
    ggplot2::theme_minimal() +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
}
```


```{r}
#| label: station-summary-table
#| fig-cap: Table 2. Total number of detections and number of individual fish heard per project receiver.
#| fig-cap-location: top

station_summary <- prep_station_table(qualified, type = "receiver")

reactable::reactable(station_summary)
```


```{r}
#| label: detection-map-leaflet
#| fig-cap: Figure 4. Number of detections per project receiver. Points represent receiver locations, while size and color reflect the number of detections at that location.

station_spatial <- prep_station_spatial(qualified, type = "receiver")

mapview::mapview(
  station_spatial,
  zcol = "Detections",
  cex = "Individuals",
  layer.name = "Matched detections"
)
```


```{r}
#| label: detection-map
#| eval: false

# This gives a static map. Currently not run bc we have the js map. Will need
#   better basemap (more refined than 110m Natural Earth) if this is used in the future
# station_spatial <- qualified |>
#   unique(by = "station")
station_spatial <- station_spatial[station_summary[, Station := toupper(Station)], , on = c("station" = "Station")] |>
  data.frame() |>
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

station_limits <- st_bbox(station_spatial)
x_nudge <- (station_limits[3] - station_limits[1]) * (1 / 10)
y_nudge <- (station_limits[4] - station_limits[2]) * (1 / 10)

# ggplot() +
#   geom_sf(data = natural_earth, fill = 'lightgray') +
#   geom_sf(data = station_spatial,
#           aes(size = Detections, color = Individuals)) +
#   labs(subtitle = 'Records by receivers') +
#   scale_color_viridis_c() +
#   coord_sf(xlim = c(station_limits['xmin'] - x_nudge, station_limits['xmax'] + x_nudge),
#            ylim = c(station_limits['ymin'] - y_nudge, station_limits['ymax'] + y_nudge)) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))
```





```{r results='asis', echo=FALSE}
if (is.null(params$since)) {
  cat("<!---")
}
```
## What's new?

```{r}
#| label: new-matches
if (!is.null(params$since)) {
  since_date <- data.table::as.IDate(params$since)
} else {
  since_date <- data.table::as.IDate("1970-01-01")
}
new_matches <- qualified[datelastmodified > since_date]
```

Since `r format(since_date, '%B %Y')`, `r format(nrow(new_matches), big.mark = ',')` detections of `r uniqueN(new_matches, by  = 'fieldnumber')` individuals have been updated or newly-matched.

```{r}
#| label: new-otn-match-table
#| column: page
#| fig-cap: Table 3. Total number of new detections and individual fish heard per project receiver.
#| fig-cap-location: top

new_mt <- prep_match_table(new_matches, pis, type = "receiver")

reactable::reactable(new_mt,
  columns = list(
    PI = reactable::colDef(
      html = T,
      cell = function(value, index) {
        sprintf(
          '<a href=mailto:%s target="_blank">%s</a>',
          new_mt$PI_emails[index], value
        )
      },
      minWidth = 150
    ),
    POC = reactable::colDef(
      html = T,
      cell = function(value, index) {
        sprintf(
          '<a href=mailto:%s target="_blank">%s</a>',
          new_mt$POC_emails[index], value
        )
      },
      minWidth = 150
    ),
    PI_emails = reactable::colDef(show = F),
    POC_emails = reactable::colDef(show = F),
    `Project name` = reactable::colDef(minWidth = 200)
  )
)
```

```{r}
#| label: new-otn-match-map
#| fig-cap: Figure 5. Bounding box of external projects detected since the last data push. This does not necessarily reflect the distribution of fish heard by this project's receivers.

new_otn_sf <- otn_sf[grepl(
  paste(unique(new_matches$trackercode), collapse = "|"),
  otn_sf$collectioncode
), ]
otn_limits <- sf::st_bbox(new_otn_sf)

ggplot2::ggplot() +
  ggplot2::geom_sf(data = natural_earth) +
  ggplot2::geom_sf(data = new_otn_sf, fill = NA, color = "blue") +
  ggplot2::coord_sf(
    xlim = c(otn_limits["xmin"] - 5, otn_limits["xmax"] + 5),
    ylim = c(otn_limits["ymin"] - 5, otn_limits["ymax"] + 5)
  ) +
  ggplot2::labs(title = "Geographic extent of newly-detected projects") +
  ggplot2::theme_minimal()
```


```{r}
#| label: new-station-summary-table
#| fig-cap: Table 4. Total number of detections and number of individual fish heard per project receiver since the last data push.
#| fig-cap-location: top

new_station_summary <- prep_station_table(qualified, "receiver")

reactable::reactable(station_summary)
```
</figure>

```{r}
#| label: new-detection-map

# station_spatial <- qualified |>
#   unique(by = 'stationname') |>
#   DT(station_summary, , on = c('stationname'= 'Station')) |>
#   data.frame() |>
#   st_as_sf(coords = c('deploy_long', 'deploy_lat'), crs = 4326)
#
#
# ggplot() +
#   geom_sf(data = bathy, color = 'lightgray') +
#   geom_sf(data = midatl) +
#   geom_sf(data = station_spatial,
#           aes(linewidth = Detections, color = Individuals)) +
#   labs(subtitle = 'New records by Mid-Bay receivers') +
#   scale_color_viridis_c() +
#   coord_sf(xlim = c(-76.5, -76.15), ylim = c(38.25, 38.45)) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r results='asis', echo=FALSE}
if (is.null(params$since)) {
  cat("-->")
}
```

## Unmatched detections

```{r}
#| label: unqualified

unqual_f <- unqualified[, .N, by = "fieldnumber"][N <= 1]
data.table::setnames(unqual_f, c("Transmitter", "N"))

unqual_real <- unqualified[, .N, by = "fieldnumber"][N > 1]
data.table::setnames(unqual_real, c("Transmitter", "N"))
```

Some detections were not matched to other investigators via OTN nodes. There are `r format(nrow(unqualified), big.mark = ',')` of these ["unqualified" detections](https://members.oceantrack.org/data/otn-detection-extract-documentation-matched-to-animals#autotoc-item-autotoc-2) across `r data.table::uniqueN(unqualified, by  = 'fieldnumber')` transmitters.

`r nrow(unqual_f)` of these are very likely false, as they only have one detection; this leaves detections of `r nrow(unqual_real)` transmitters that could find a home elsewhere.

### Likely false detections (N detections = 1)

```{r}
#| label: unqualified-false


## NOTE TO SELF START HERE
reactable(unqual_f)
```

### Possibly real detections (N detections > 1)

```{r}
#| label: unqualified-real

reactable(unqual_real)
```


```{r}
#| label: temporal-distribution-unqual
#| fig-cap: Figure 6. Temporal distribution of unmatched detections by receiver, i.e., the dates when a receiver in this project heard a transmitter that was not matched to an external project.

unqualified[, day := as.Date(datecollected)]
unqualified_time <- unique(unqualified, by = c("station", "day"))

ggplot(unqualified_time) +
  geom_tile(aes(x = day, y = station)) +
  labs(
    x = "", y = "",
    subtitle = "Temporal distribution of unmatched detections by station"
  ) +
  theme_minimal()
```

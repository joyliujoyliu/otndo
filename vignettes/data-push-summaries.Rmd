---
title: "Data Push Summaries"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Push Summaries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(matos)
```

Oh, boy; oh, boy! Here it is: one of the [three yearly data pushes](https://members.oceantrack.org/faq#autotoc-item-autotoc-6) and [Kim](mailto:east.coast.telemetry@gmail.com) has hit you with a slew of automated emails to let you know that the data you've recorded on your receivers has been matched to other projects in MATOS or one of the other OTN nodes.

What now? What's been updated? Who might I contact for more information? Well, `make_receiver_push_summary` and `make_tag_push_summary` are here to help.

## ACT members

If you're an ACT member, the first thing you'll want to do is list the projects for which you have access.

```{r}
list_my_projects(read_access = T)
```

From here, you can just provide your project name or number and let it rip. Below, I provide the number associated with "UMCES BOEM Offshore Wind Energy".

```{r, eval=FALSE}
make_receiver_push_summary(87)
```

This function does a bit of data cleaning on the front end and then runs everything through a [Quarto](https://quarto.org/) or [RMarkdown](https://rmarkdown.rstudio.com/) report. The functions use Quarto by default, but RMarkdown will be selected if:

1.  Quarto is not installed on the computer, or
2.  the `rmd` argument is set to `TRUE`.

```{r, eval=FALSE}
# Compiles with Quarto (default)
make_receiver_push_summary(87, rmd = F)

# Compiles with RMarkdown
make_receiver_push_summary(87, rmd = T)
```

Functionality is identical for `make_tag_push_summary`:

```{r, eval=FALSE}
make_tag_push_summary(87)
```

## Other OTN-ites

If you are a member of OTN or an OTN node, such as [FACT](https://secoora.org/fact/), your data extract files are compatible with `make_receiver_push_summary` and `make_tag_push_summmary`. The only difference is that you'll have to manually provide your data files -- `matos` is not set up to download them for you.

We'll use data from [Trudel 2018](#references) (<https://members.oceantrack.org/data/repository/pbsm>) to show how this might work.

### `make_receiver_push_summary`

```{r}
# Create a folder in your temporary directory to hold the sample files
td <- file.path(tempdir(), 'matos_test_files')
dir.create(td)

# Download deployment metadata
# Note "mode = 'wb'! Needed to download the file in binary
download.file('https://members.oceantrack.org/data/repository/pbsm/data-and-metadata/2018/pbsm-instrument-deployment-short-form-2018.xls',
              destfile = file.path(td, 'pbsm-instrument-deployment-short-form-2018.xls'),
              mode = 'wb')

# Download qualified detections
download.file('https://members.oceantrack.org/data/repository/pbsm/detection-extracts/pbsm_qualified_detections_2018.zip',
              destfile = file.path(td, 'pbsm_qualified_detections_2018.zip'))

# Download unqualified detections
download.file('https://members.oceantrack.org/data/repository/pbsm/detection-extracts/pbsm_unqualified_detections_2018.zip',
              destfile = file.path(td, 'pbsm_unqualified_detections_2018.zip'))

qualified_filepath <- file.path(td, 'pbsm_qualified_detections_2018.zip')
unqualified_filepath <- file.path(td, 'pbsm_unqualified_detections_2018.zip')
deployment_filepath <- file.path(td, 'pbsm-instrument-deployment-short-form-2018.xls')
```

When you have an ACT project, `matos` automatically uses the most-recent data push date as a reference point to let you know what has changed since the last time you've received new data. It doesn't know this for other networks, but you can provide a date via the `since` argument.

```{r, eval=FALSE}
make_receiver_push_summary(
  qualified = qualified_filepath,
  unqualified = unqualified_filepath,
  deployment = deployment_filepath,
  since = '2018-05-06'
)
```

There you go -- you now have a report of detections picked up by your receiver array in your working directory!

### `make_tag_push_summary`

The same process applies to summarize your deployed transmitters.

```{r}
download.file('https://members.oceantrack.org/data/repository/pbsm/detection-extracts/pbsm_matched_detections_2018.zip',
               destfile = file.path(td, 'pbsm_matched_detections_2018.zip'))

matched_filepath <- file.path(td, 'pbsm_matched_detections_2018.zip')
```

```{r, eval=FALSE}
make_tag_push_summary(matched = matched_filepath,
                      since = '2018-05-01')
```

## Suggestions

I am always open to suggestions on what could be added to change to make this more useful for you. Please [open an issue on GitHub](https://github.com/mhpob/matos/issues) or [email me](mailto:obrien@umces.edu) with your thoughts.

## Errors and how to fix them

    Could not determine mime type for `~\Matcheddetections_layer.fgb'
    Error: pandoc document conversion failed with error 63

This error is created by an old version of the [`mapview` package](https://r-spatial.github.io/mapview/) (pre-June 2021) and has to do with the package's switch to using a [file geodatabase](https://pro.arcgis.com/en/pro-app/latest/help/data/geodatabases/manage-file-gdb/file-geodatabases.htm) to increase plotting performance. To fix this, you have two options:

1.  Update `mapview` (suggested), or
2.  Run `mapviewOptions(fgb = FALSE)` before attempting to run `make_receiver_push_summary` or `make_tag_push_summary`. Note that this will make the report build more slowly.

## References {#references}

Trudel, Marc. "A Pilot Study to Investigate the Migration of Atlantic Salmon Post-Smolts and Their Interactions with Aquaculture in Passamaquoddy Bay, New Brunswick, Canada." Ocean Tracking Network, 2018. <https://members.oceantrack.org/project?ccode=PBSM>.

#' Log in to your MATOS account
#'
#' This function prompts you for the username (email) and password associated with
#' your MATOS account. This is necessary so that you may interface with any
#' project-specific files. If you don't have a MATOS account
#' \href{https://matos.asascience.com/account/signup}{you can sign up for one here}.
#' Log in is completed using the \href{https://rstudio.github.io/rstudio-extensions/rstudioapi.html}{RStudio API};
#' this probably won't work if you're not using RStudio, so it will be changed in the future.
#' A pop up will appear asking for your username and password. If everything works
#' out, your credentials will be kept in the sessions' cookies. Your username/password
#' will not be saved -- this was done intentionally so that you don't accidentally
#' save credentials in a public script.
#'
#' @examples
#' \dontrun{
#' # Type:
#' matos_login()
#' # ...then follow the on-screen prompts
#' }

matos_login <- function(){
  credentials <- list(
    UserName = getPass::getPass('Username:', noblank = T),
    Password = getPass::getPass('Password:', noblank = T)
  )


  login_response <- httr::POST(
    'https://matos.asascience.com/account/login',
    body = credentials,
    encode = 'form'
  )

  if('rstudioapi' %in% installed.packages()){
    if(grepl('login', login_response)){
      rstudioapi::showDialog('Login unsuccessful :(',
                             'Your username/password combination was not recognized.
                             Please re-run the funtion and try again.')
      cli::cli_abort('Login unsuccessful.',
                     'i' = 'Please re-run the funtion and try again.')

    } else{
      rstudioapi::showDialog('Login successful!',
                             'You are now logged into your MATOS profile.')
      cli::cli_alert_success('Login successful!')
    }
  } else{
    if(grepl('login', login_response)){
      tcltk::tk_messageBox('ok',
                           'Your username/password combination was not recognized.
                           Please re-run the funtion and try again.',
                           caption = 'Login unuccessful :(')
      cli::cli_abort('Login unsuccessful.',
                     'i' = 'Please re-run the funtion and try again.')

    } else{
      tcltk::tk_messageBox('ok',
                           'You are now logged into your MATOS profile.',
                           caption = 'Login unuccessful !')
      cli::cli_alert_success('Login successful!')
    }
  }
}






#' Internal functions used by \code{matos}
#'
#' Non-exported utility functions used by other functions in \code{matos}.
#'
#' @section Details:
#' \code{get_file_list} scrapes the HTML associated with the project or data
#' extraction files page provided with a given project.
#'
#' \code{get_project_number} finds the internal MATOS number associated with each
#' project by scraping the HTML of the main MATOS projects page.
#'
#' \code{get_project_name} finds the MATOS project name associated with the given
#' project number by scraping the HTML of the main MATOS projects page.
#'
#' \code{html_table_to_df} converts the HTML table provided by \code{get_file_list}
#' into a R-usable data frame.
#'
#' \code{login_check} pings protected URLs and calls \code{matos_login} when referred
#' to the login page.
#'
#' \code{scrape_file_urls} is used internally by \code{html_table_to_df} to extract
#' the URLs associates with each "Download" link.
#'
#' \code{download_process} is used internally by \code{get_project_file} and
#' \code{get_extract_file}
#'
#' @param project_number Number of the project
#' @param data_type one of "dataextractionfiles" or "projectfiles".
#' @param project Character string of the full MATOS project name. This will be the
#' big name in bold at the top of your project page, not the "Project Title" below it.
#' Will be coerced to all lower case, so capitalization doesn't matter.
#' @param url The (protected) URL that the overlapping function is trying to call.
#' @param html_file_list Listed files in HTML form. Always the result of
#' \code{get_file_list}
#'
#'
#' @name utilities

get_file_list <- function(project_number, data_type){

  url <- paste('https://matos.asascience.com/project',
               data_type,
               project_number, sep = '/')

  login_check(url)

  httr::GET(url)
}


#' @rdname utilities
#'
get_project_number <- function(project){
  projects <- list_projects()
  projects[tolower(projects$name) == tolower(trimws(project)),]$number
}


#' @rdname utilities
#'
get_project_name <- function(project){
  projects <- list_projects()
  projects[projects$number == project,]$name
}


#' @rdname utilities
#'
html_table_to_df <- function(html_file_list){

  df <- httr::content(html_file_list, 'parsed') %>%
    rvest::html_element(xpath = '//*[@id="content"]/table') %>%
    rvest::html_table() %>%
    data.frame()
  names(df) <- tolower(gsub('\\.', '_', names(df)))


  df <- df[, names(df) != 'var_4']
  df$upload_date <- as.Date(df$upload_date, format = '%m/%d/%Y')
  df$project <- gsub('.*/', '', html_file_list$url)

  urls <- scrape_file_urls(html_file_list)

  df <- cbind(df, url = urls)

  # Parse file name for data extraction files
  if(any(unique(df$file_type) == 'Data Extraction File')){
    df <- data.frame(detection_type = gsub('.*\\d_|_det.*', '', df$file_name),
                     detection_year = as.numeric(gsub('.*_|.zip', '', df$file_name)),
                     df)
    df <- df[, c('project', 'file_type', 'detection_type', 'detection_year',
                 'upload_date', 'file_name', 'url')]
  }else{
    df <- df[, c('project', 'file_type', 'upload_date', 'file_name', 'url')]
  }


  df
}


#' @rdname utilities
#'
login_check <- function(url = 'https://matos.asascience.com/report/submit'){

  check_response <- httr::HEAD(url)

  if(nrow(check_response$cookies) == 1){
    cli::cli_alert_warning('Please log in.')

    matos_login()
  }

}

#' @rdname utilities
#'
scrape_file_urls <- function(html_file_list){
  urls <- httr::content(html_file_list, 'parsed') %>%
    rvest::html_node('body') %>%
    rvest::html_nodes('a') %>%
    rvest::html_attr('href')

  urls <- grep('projectfile', urls, value = T)

  paste0('https://matos.asascience.com', urls)
}

#' @rdname utilities
#'
download_process <- function(url, out_dir, overwrite, to_vue){

  cli::cli_h1("Downloading files")

  GET_header <- httr::GET(url)

  response <-  httr::GET(
    url,
    httr::write_disk(
      path = file.path(out_dir,
                       sub('.*filename=', '',
                           httr::headers(GET_header)$'content-disposition')),
      overwrite = overwrite)
  )

  file_loc <- file.path(response$content)

  cli::cli_alert_success('\nFile(s) saved to:')
  cat('  ', paste(file_loc, collapse = '\n   '), '\n')


  cli::cli_h1("Unzipping files")

  if(grepl('zip', file_loc)){
    file_loc <- unzip(file_loc, exdir = out_dir, setTimes = FALSE)

    cli::cli_alert_success('\nFile(s) unzipped to:')
    cat('  ', paste(file_loc, collapse = '\n   '), '\n')
  }

  if(isTRUE(to_vue)){

    cli::cli_h1("Converting to VUE CSV format")

    file_csv <- grep('.csv', file_loc, value = T)
    matos <- read.csv(
      file_csv
    )


    matos$transmitter.name <- ''
    matos$transmitter.serial <- ''

    matos <- matos[, c('datecollected', 'receiver', 'tagname', 'transmitter.name',
                       'transmitter.serial', 'sensorraw', 'sensorunit', 'station',
                       'latitude', 'longitude')]

    names(matos) <- c('Date and Time (UTC)', 'Receiver', 'Transmitter',
                      'Transmitter Name', 'Transmitter Serial', 'Sensor Value',
                      'Sensor Unit', 'Station Name', 'Latitude', 'Longitude')

    write.csv(matos, file_csv, row.names = F)
    cli::cli_alert_success('CSV converted to VUE format.')

  }

  file_loc
}
